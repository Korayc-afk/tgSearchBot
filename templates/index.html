<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PadiÅŸah Telegram Monitoring</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .padisah-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .header-logo {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: 3px solid rgba(255,255,255,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            position: relative;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .list-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .list-input input {
            flex: 1;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .groups-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }

        .group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .group-item:last-child {
            border-bottom: none;
        }

        .group-item:hover {
            background: #f8f9fa;
        }

        .group-info {
            flex: 1;
        }

        .group-name {
            font-weight: 600;
            color: #333;
        }

        .group-id {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .results-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .result-item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
        }

        .result-item h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .group-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .group-header h4 {
            color: white;
            margin: 0;
            font-size: 18px;
        }

        .group-header .group-id {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .result-item p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }

        .result-item a {
            color: #667eea;
            text-decoration: none;
        }

        .result-item a:hover {
            text-decoration: underline;
        }

        .message-box {
            background: #fff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 3px solid #667eea;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Toast Bildirimleri */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            min-width: 300px;
            max-width: 500px;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            font-size: 14px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.toast-exit {
            animation: slideOut 0.3s ease-out;
        }

        .toast-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .toast-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .toast-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .toast-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: inherit;
            opacity: 0.7;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast-close:hover {
            opacity: 1;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <img src="/logoSeffaf.png" alt="PadiÅŸah Logo" class="padisah-logo">
                <img src="/s-l400.jpg" alt="Logo" class="header-logo">
            </div>
            <div>
                <h1>ğŸ“± Telegram Monitoring Bot</h1>
                <p>Grup mesajlarÄ±nÄ±zÄ± izleyin ve bahsedilmelerinizi takip edin</p>
            </div>
        </div>

        <div class="content">
            <div id="alert" class="alert"></div>
            <div id="toast-container" class="toast-container"></div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('settings')">âš™ï¸ Ayarlar</button>
                <button class="tab" onclick="switchTab('results')">ğŸ“Š SonuÃ§lar</button>
            </div>

            <!-- Ayarlar Tab -->
            <div id="settings" class="tab-content active">
                <h2>Bot AyarlarÄ±</h2>
                <form id="configForm">
                    <div class="form-group">
                        <label>API ID *</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="api_id" placeholder="Telegram API ID" required style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="testTelegramAPI()" id="test-api-btn">ğŸ§ª Test Et</button>
                        </div>
                        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                            ** API ID ve API Hash nasÄ±l alÄ±nÄ±r?<br>
                            1. https://my.telegram.org/apps adresine gidin<br>
                            2. Telegram hesabÄ±nÄ±zla giriÅŸ yapÄ±n<br>
                            3. "API development tools" bÃ¶lÃ¼mÃ¼nde "Create application" butonuna tÄ±klayÄ±n<br>
                            4. Uygulama bilgilerini doldurun (herhangi bir isim ve kÄ±sa isim yazabilirsiniz)<br>
                            5. API ID ve API Hash deÄŸerlerini kopyalayÄ±p buraya yapÄ±ÅŸtÄ±rÄ±n
                        </small>
                    </div>

                    <div class="form-group">
                        <label>API Hash *</label>
                        <input type="password" id="api_hash" placeholder="Telegram API Hash" required>
                    </div>

                    <div class="form-group">
                        <label>Telefon NumarasÄ± *</label>
                        <input type="text" id="phone_number" placeholder="+90XXXXXXXXXX" required>
                    </div>

                    <div class="form-group">
                        <label>Aranacak Kelimeler</label>
                        <textarea id="keywords-input" placeholder="Mesajlarda veya gÃ¶rsellerde aranacak kelimeleri virgÃ¼lle ayÄ±rarak yazÄ±n (Ã¶rn: Ahmet YÄ±lmaz, reklam, bahsedildi)" style="min-height: 80px;"></textarea>
                        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                            Gruplardaki mesajlarda veya gÃ¶rsellerde geÃ§en kelimeleri arar. Kendi adÄ±nÄ±z, bahsedilme durumlarÄ± veya Ã¶zel kelimeleri virgÃ¼l (,) ile ayÄ±rarak yazÄ±n. Ã–rnek: Ahmet YÄ±lmaz, reklam, bahsedildi, link
                        </small>
                    </div>

                    <div class="form-group">
                        <label>Aranacak Linkler</label>
                        <div id="links-list"></div>
                        <div class="list-input">
                            <input type="text" id="new-link" placeholder="Mesajlarda aranacak link ekle (Ã¶rn: t.me/kullanici, example.com)">
                            <button type="button" class="btn btn-secondary" onclick="addLink()">Ekle</button>
                        </div>
                        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                            Gruplardaki mesajlarda geÃ§en linklerinizi arar. Kendi Telegram linkiniz, web siteniz vb. linkleri ekleyin.
                        </small>
                    </div>

                    <div class="form-group">
                        <label>Tarama Zaman AralÄ±ÄŸÄ±</label>
                        <select id="scan_time_range" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
                            <option value="1day">Son 1 GÃ¼n</option>
                            <option value="7days" selected>Son 7 GÃ¼n</option>
                            <option value="30days">Son 30 GÃ¼n</option>
                        </select>
                        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                            Bot baÅŸlatÄ±ldÄ±ÄŸÄ±nda seÃ§ilen zaman aralÄ±ÄŸÄ±ndaki geÃ§miÅŸ mesajlar taranÄ±r. Tarama tamamlandÄ±ktan sonra yeni mesajlar otomatik olarak izlenmeye devam eder.
                        </small>
                    </div>

                    <!-- Gruplar BÃ¶lÃ¼mÃ¼ -->
                    <div class="form-group" style="background: #fff; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0; margin-top: 20px;">
                        <h3 style="margin-bottom: 15px; color: #667eea;">ğŸ‘¥ Ä°zlenecek Gruplar</h3>
                        
                        <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea; margin-bottom: 15px;">
                            <p style="color: #666; font-size: 14px; line-height: 1.6; margin: 0;">
                                <strong>ğŸ’¡ NasÄ±l Ã‡alÄ±ÅŸÄ±r:</strong> Telegram linklerini yapÄ±ÅŸtÄ±rarak veya grup adÄ±nÄ± yazarak ekleyin. 
                                Ä°zlemek istediÄŸiniz gruplarÄ± ekleyin ve "GruplarÄ± Kaydet" butonuna tÄ±klayÄ±n.
                            </p>
                        </div>

                        <div style="background: #fff; padding: 15px; border-radius: 8px; border: 2px solid #e0e0e0; margin-bottom: 15px;">
                            <h4 style="margin-bottom: 10px;">ğŸ” Grup/Kanal Ekle</h4>
                            <div style="margin-bottom: 10px;">
                                <textarea id="search-group-name" placeholder="Grup adÄ± yazÄ±n VEYA Telegram linki yapÄ±ÅŸtÄ±rÄ±n (Ã¶rn: https://t.me/padisahbet)&#10;Birden fazla link eklemek iÃ§in her satÄ±ra bir link yazÄ±n veya virgÃ¼lle ayÄ±rÄ±n" style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                            </div>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <button type="button" class="btn btn-primary" onclick="addGroupsFromInput()" id="search-group-btn" style="flex: 1;">â• Ekle</button>
                                <button type="button" class="btn btn-secondary" onclick="searchGroups()" id="search-btn">ğŸ” Ara</button>
                            </div>
                            <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                                ğŸ’¡ Ä°pucu: Telegram linklerini (https://t.me/kanaladi) yapÄ±ÅŸtÄ±rarak direkt ekleyebilirsiniz. Birden fazla link iÃ§in her satÄ±ra bir link yazÄ±n.
                            </small>
                            <div id="search-results" style="margin-top: 15px; display: none;">
                                <h5 style="margin-bottom: 10px;">Bulunan Gruplar:</h5>
                                <div id="search-results-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px;"></div>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <button type="button" class="btn btn-secondary" onclick="saveGroupSelection()">ğŸ’¾ GruplarÄ± Kaydet</button>
                        </div>
                        
                        <div id="groups-container" style="margin-top: 15px;"></div>
                    </div>

                    <div class="form-group" style="background: #f0f7ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                        <h4 style="margin-bottom: 10px; color: #667eea;">â„¹ï¸ Gizli/KapalÄ± Gruplarda NasÄ±l Ã‡alÄ±ÅŸÄ±r?</h4>
                        
                        <div style="background: #fff; padding: 12px; border-radius: 5px; margin-bottom: 15px;">
                            <h5 style="color: #667eea; margin-bottom: 8px;">ğŸ”‘ Ã‡alÄ±ÅŸma MantÄ±ÄŸÄ±:</h5>
                            <p style="color: #666; font-size: 14px; line-height: 1.6;">
                                Bu bot, <strong>sizin Telegram hesabÄ±nÄ±zla</strong> Ã§alÄ±ÅŸÄ±r. Yani:
                            </p>
                            <ul style="color: #666; font-size: 14px; line-height: 1.8; margin-left: 20px; margin-top: 8px;">
                                <li>Bot, sizin telefon numaranÄ±z ve API bilgilerinizle Telegram'a baÄŸlanÄ±r</li>
                                <li>Sizin <strong>Ã¼ye olduÄŸunuz tÃ¼m gruplara</strong> eriÅŸebilir (aÃ§Ä±k veya kapalÄ± fark etmez)</li>
                                <li>Telegram uygulamanÄ±zda gÃ¶rebildiÄŸiniz mesajlarÄ± bot da gÃ¶rebilir</li>
                                <li>Grup listesinde gÃ¶rÃ¼nen tÃ¼m gruplar otomatik olarak tespit edilir</li>
                            </ul>
                        </div>

                        <div style="background: #fff; padding: 12px; border-radius: 5px; margin-bottom: 15px;">
                            <h5 style="color: #667eea; margin-bottom: 8px;">ğŸ”“ AÃ§Ä±k Gruplar:</h5>
                            <p style="color: #666; font-size: 14px; line-height: 1.6;">
                                Herkesin katÄ±labildiÄŸi gruplar. Bot bu gruplardaki mesajlarÄ± rahatlÄ±kla okuyabilir.
                            </p>
                        </div>

                        <div style="background: #fff; padding: 12px; border-radius: 5px; margin-bottom: 15px;">
                            <h5 style="color: #667eea; margin-bottom: 8px;">ğŸ”’ KapalÄ±/Ã–zel Gruplar:</h5>
                            <p style="color: #666; font-size: 14px; line-height: 1.6; margin-bottom: 8px;">
                                Sadece davet ile katÄ±lÄ±m. Bot, sizin Ã¼ye olduÄŸunuz kapalÄ± gruplarda da Ã§alÄ±ÅŸÄ±r Ã§Ã¼nkÃ¼:
                            </p>
                            <ul style="color: #666; font-size: 14px; line-height: 1.8; margin-left: 20px;">
                                <li>âœ… Sizin hesabÄ±nÄ±zla baÄŸlandÄ±ÄŸÄ± iÃ§in sizin eriÅŸebildiÄŸiniz tÃ¼m gruplara eriÅŸir</li>
                                <li>âœ… Grup listesinde gÃ¶rÃ¼nen tÃ¼m gruplar otomatik tespit edilir</li>
                                <li>âœ… MesajlarÄ± okumak iÃ§in grup Ã¼yeliÄŸi yeterlidir</li>
                            </ul>
                        </div>

                        <div style="background: #fff3cd; padding: 12px; border-radius: 5px; margin-bottom: 15px; border-left: 3px solid #ffc107;">
                            <h5 style="color: #856404; margin-bottom: 8px;">âš ï¸ SÄ±nÄ±rlamalar:</h5>
                            <ul style="color: #856404; font-size: 14px; line-height: 1.8; margin-left: 20px;">
                                <li>Grup yÃ¶neticileri botlarÄ± engellemiÅŸse mesajlar okunamayabilir</li>
                                <li>Ã‡ok eski mesajlar (1-2 yÄ±l Ã¶ncesi) Telegram tarafÄ±ndan sÄ±nÄ±rlandÄ±rÄ±lmÄ±ÅŸ olabilir</li>
                                <li>Rate limit: Ã‡ok fazla mesaj Ã§ekmek Telegram tarafÄ±ndan yavaÅŸlatÄ±labilir</li>
                                <li><strong>Secret Chats (Gizli Sohbetler)</strong> eriÅŸilemez - bunlar end-to-end encrypted'dÄ±r</li>
                            </ul>
                        </div>

                        <div style="background: #d1ecf1; padding: 12px; border-radius: 5px; border-left: 3px solid #0c5460;">
                            <h5 style="color: #0c5460; margin-bottom: 8px;">ğŸ’¡ Ä°puÃ§larÄ±:</h5>
                            <ul style="color: #0c5460; font-size: 14px; line-height: 1.8; margin-left: 20px;">
                                <li>GeÃ§miÅŸ mesaj taramasÄ± iÃ§in "Son 7 GÃ¼n" veya "Son 30 GÃ¼n" seÃ§eneÄŸini kullanÄ±n</li>
                                <li>Ã‡ok eski mesajlar iÃ§in Telegram API limitleri olabilir</li>
                                <li>Telegram linklerini yapÄ±ÅŸtÄ±rarak gruplarÄ± ekleyebilirsiniz</li>
                                <li>EÄŸer bir grup listede gÃ¶rÃ¼nmÃ¼yorsa, o gruba Ã¼ye deÄŸilsiniz demektir</li>
                            </ul>
                        </div>
                    </div>

                    <div class="actions">
                        <button type="submit" class="btn btn-primary">ğŸ’¾ AyarlarÄ± Kaydet</button>
                        <button type="button" class="btn btn-secondary" onclick="loadConfig()">ğŸ”„ Yenile</button>
                    </div>
                </form>
            </div>


            <!-- Telegram GiriÅŸ Modal -->
            <div id="login-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; flex-direction: column;">
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative;">
                    <button onclick="closeLoginModal()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">Ã—</button>
                    <h2 style="margin-bottom: 20px; color: #667eea;">ğŸ” Telegram'a GiriÅŸ Yap</h2>
                    <div id="login-step-1">
                        <p style="margin-bottom: 15px; color: #666;">Telefon numaranÄ±zÄ± girin. Kod gÃ¶nderilecektir.</p>
                        <input type="text" id="login-phone" placeholder="+90XXXXXXXXXX" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box;">
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="sendLoginCode()" style="flex: 1;">ğŸ“± Kod GÃ¶nder</button>
                            <button class="btn btn-secondary" onclick="closeLoginModal()">Ä°ptal</button>
                        </div>
                    </div>
                    <div id="login-step-2" style="display: none;">
                        <p style="margin-bottom: 15px; color: #666;">Telefon numaranÄ±za gÃ¶nderilen kodu girin:</p>
                        <input type="text" id="login-code" placeholder="12345" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; font-size: 18px; text-align: center; letter-spacing: 5px;">
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="verifyLoginCode()" style="flex: 1;">âœ… GiriÅŸ Yap</button>
                            <button class="btn btn-secondary" onclick="closeLoginModal()">Ä°ptal</button>
                        </div>
                    </div>
                    <div id="login-step-password" style="display: none;">
                        <p style="margin-bottom: 15px; color: #666;">Ä°ki faktÃ¶rlÃ¼ doÄŸrulama ÅŸifrenizi girin:</p>
                        <input type="password" id="login-password" placeholder="Åifre" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box;">
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="verifyLoginPassword()" style="flex: 1;">ğŸ”’ DoÄŸrula</button>
                            <button class="btn btn-secondary" onclick="closeLoginModal()">Ä°ptal</button>
                        </div>
                    </div>
                    <div id="login-status" style="margin-top: 15px;"></div>
                </div>
            </div>

            <!-- Silme Onay Modal -->
            <div id="delete-confirm-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; flex-direction: column;">
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 450px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative; text-align: center;">
                    <button onclick="closeDeleteModal()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">Ã—</button>
                    <div style="font-size: 64px; margin-bottom: 20px;">ğŸ—‘ï¸</div>
                    <h2 style="margin-bottom: 15px; color: #dc3545; font-size: 24px;">SonuÃ§larÄ± Sil</h2>
                    <p style="color: #666; margin-bottom: 25px; line-height: 1.6; font-size: 16px;">
                        TÃ¼m sonuÃ§larÄ± silmek istediÄŸinizden <strong>emin misiniz?</strong><br>
                        Bu iÅŸlem <strong>geri alÄ±namaz!</strong>
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="confirmDelete()" class="btn btn-danger" style="background: #dc3545; border-color: #dc3545; padding: 12px 30px; font-size: 16px; font-weight: 600; flex: 1;">
                            âœ… Evet, Sil
                        </button>
                        <button onclick="closeDeleteModal()" class="btn btn-secondary" style="padding: 12px 30px; font-size: 16px; font-weight: 600; flex: 1;">
                            âŒ HayÄ±r, Ä°ptal
                        </button>
                    </div>
                </div>
            </div>

            <!-- SonuÃ§lar Tab -->
            <div id="results" class="tab-content">
                <h2>ğŸ“Š Reklam KontrolÃ¼</h2>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                    <p style="color: #856404; margin: 0;">
                        <strong>ğŸ’¡ NasÄ±l KullanÄ±lÄ±r:</strong> Ayarlar sekmesinde seÃ§ili gruplar iÃ§in tarih aralÄ±klarÄ±nÄ± belirleyin, 
                        sonra "ğŸ” Tara" butonuna tÄ±klayÄ±n. Bot seÃ§ilen tarih aralÄ±ÄŸÄ±ndaki mesajlarÄ± tarayacak ve reklamÄ±nÄ±zÄ±n geÃ§ip geÃ§mediÄŸini kontrol edecektir.
                    </p>
                </div>
                
                <!-- Tarama Butonu -->
                <div style="background: #f0f7ff; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 10px 0; color: #667eea; font-size: 18px;">ğŸ” Tarama Ä°ÅŸlemi</h3>
                            <p style="margin: 0; color: #666; font-size: 14px;">SeÃ§ili gruplar iÃ§in belirlenen tarih aralÄ±klarÄ±nda tarama yapÄ±n</p>
                        </div>
                        <button class="btn btn-success" onclick="startScan()" id="scan-btn" style="background: #28a745; border-color: #28a745; padding: 12px 30px; font-size: 16px; font-weight: 600; white-space: nowrap;">
                            ğŸ” Tara
                        </button>
                    </div>
                    <div id="scan-status" style="margin-top: 15px; display: none;"></div>
                    <!-- Progress Bar -->
                    <div id="scan-progress" style="margin-top: 15px; display: none;">
                        <div style="background: #e9ecef; border-radius: 10px; height: 30px; overflow: hidden; position: relative;">
                            <div id="progress-bar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">
                                <span id="progress-text">0%</span>
                            </div>
                        </div>
                        <div id="progress-details" style="margin-top: 10px; font-size: 14px; color: #666; text-align: center;"></div>
                    </div>
                    
                    <!-- DEBUG PANEL -->
                    <div id="debug-panel" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border: 2px solid #dc3545; border-radius: 8px; display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #dc3545;">ğŸ› DEBUG BÄ°LGÄ°LERÄ°</h4>
                            <button onclick="toggleDebugPanel()" class="btn btn-small" style="padding: 5px 10px; font-size: 12px;">Gizle</button>
                        </div>
                        <div id="debug-content" style="max-height: 300px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.5;">
                            <div style="color: #0f0;">[DEBUG] Debug paneli baÅŸlatÄ±lÄ±yor...</div>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            <button onclick="refreshDebugLogs()" class="btn btn-primary btn-small" style="padding: 5px 15px; font-size: 12px;">ğŸ”„ LoglarÄ± Yenile</button>
                            <button onclick="clearDebugLogs()" class="btn btn-secondary btn-small" style="padding: 5px 15px; font-size: 12px;">ğŸ—‘ï¸ Temizle</button>
                        </div>
                    </div>
                </div>
                
                <!-- SonuÃ§lar -->
                <div style="margin-bottom: 20px; position: relative;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="loadResults()">ğŸ”„ SonuÃ§larÄ± Yenile</button>
                        <button class="btn btn-success" onclick="exportToExcel()" style="background: #28a745; border-color: #28a745;">ğŸ“Š Excel Ä°ndir</button>
                        <button class="btn btn-danger" onclick="clearOldResults()" style="background: #dc3545; border-color: #dc3545;">ğŸ—‘ï¸ Eski SonuÃ§larÄ± Temizle</button>
                        <span id="results-count" style="padding: 10px; color: #666; font-weight: 600;"></span>
                    </div>
                    
                    <!-- Grup Filtresi (SaÄŸ Ãœst) -->
                    <div id="group-filter-panel" style="position: absolute; top: 0; right: 0; background: white; border: 2px solid #667eea; border-radius: 12px; padding: 15px; min-width: 250px; max-width: 350px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000; display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #667eea; font-size: 16px;">ğŸ” Grup Filtresi</h4>
                            <button onclick="toggleGroupFilter()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">Ã—</button>
                        </div>
                        <div style="margin-bottom: 10px; display: flex; gap: 5px;">
                            <button onclick="selectAllGroups()" class="btn btn-small" style="padding: 5px 10px; font-size: 11px; flex: 1;">âœ… TÃ¼mÃ¼nÃ¼ SeÃ§</button>
                            <button onclick="deselectAllGroups()" class="btn btn-small" style="padding: 5px 10px; font-size: 11px; flex: 1;">âŒ Temizle</button>
                        </div>
                        <div id="group-filter-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px;">
                            <div style="color: #999; font-size: 12px; text-align: center; padding: 20px;">SonuÃ§lar yÃ¼klendikten sonra gruplar burada gÃ¶rÃ¼necek...</div>
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0; font-size: 12px; color: #666; text-align: center;">
                            <span id="filtered-count">0</span> grup seÃ§ili
                        </div>
                    </div>
                    
                    <!-- Filtre Butonu -->
                    <button onclick="toggleGroupFilter()" class="btn" style="position: absolute; top: 0; right: 0; background: #667eea; border-color: #667eea; color: white; padding: 8px 15px; font-size: 14px;">
                        ğŸ” Grup Filtresi
                    </button>
                    
                    <div id="results-container" style="margin-top: 50px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let keywords = [];
        let links = [];
        let selectedGroups = []; // {id: number, name: string} formatÄ±nda
        let allGroupsCache = {}; // Grup ID'lerine gÃ¶re grup bilgilerini sakla

        // Sayfa yÃ¼klendiÄŸinde
        window.onload = function() {
            loadConfig();
        };

        function switchTab(tabName) {
            // TÃ¼m tab'larÄ± gizle
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // SeÃ§ilen tab'Ä± gÃ¶ster
            document.getElementById(tabName).classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Tab'a Ã¶zel iÅŸlemler
            if (tabName === 'results') {
                loadResults();
            }
        }

        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                
                // API bilgilerini yÃ¼kle (API_HASH gizlenmiÅŸ olabilir, localStorage'dan kontrol et)
                const savedApiHash = localStorage.getItem('api_hash');
                document.getElementById('api_id').value = data.API_ID || '';
                document.getElementById('api_hash').value = savedApiHash || data.API_HASH || '';
                document.getElementById('phone_number').value = data.PHONE_NUMBER || '';
                document.getElementById('scan_time_range').value = data.SCAN_TIME_RANGE || '7days';
                
                keywords = data.SEARCH_KEYWORDS || [];
                links = data.SEARCH_LINKS || [];
                
                // GROUP_IDS'i dÃ¶nÃ¼ÅŸtÃ¼r (eski format: sadece ID'ler, yeni format: {id, name})
                const groupIds = data.GROUP_IDS || [];
                
                // Ã–nce grup adlarÄ±nÄ± yÃ¼kle (eÄŸer cache'de yoksa)
                if (groupIds.length > 0) {
                    try {
                        const groupsResponse = await fetch('/api/groups');
                        if (groupsResponse.ok) {
                            const groupsData = await groupsResponse.json();
                            if (groupsData.success && groupsData.groups) {
                                // Grup bilgilerini cache'e ekle
                                groupsData.groups.forEach(group => {
                                    allGroupsCache[group.id] = group;
                                });
                            }
                        }
                    } catch (e) {
                        console.log('Grup adlarÄ± yÃ¼klenemedi, cache kullanÄ±lacak:', e);
                    }
                }
                
                selectedGroups = groupIds.map(id => {
                    if (typeof id === 'object') {
                        // EÄŸer name yoksa Ã¶nce config'den, sonra cache'den al
                        if (!id.name) {
                            // Config'de name varsa kullan (yeni format)
                            if (id.name) {
                                // Zaten var
                            } else if (allGroupsCache[id.id]) {
                                id.name = allGroupsCache[id.id].name;
                            } else {
                                id.name = `Grup ${id.id}`;
                            }
                        }
                        // startDate ve endDate'i de kontrol et
                        return {
                            id: id.id,
                            name: id.name || `Grup ${id.id}`,
                            startDate: id.startDate || '',
                            endDate: id.endDate || ''
                        };
                    }
                    return { 
                        id: id, 
                        name: allGroupsCache[id]?.name || `Grup ${id}`,
                        startDate: '',
                        endDate: ''
                    };
                });
                
                // Kelimeleri virgÃ¼lle ayrÄ±lmÄ±ÅŸ string olarak gÃ¶ster
                document.getElementById('keywords-input').value = keywords.join(', ');
                renderLinks();
                
                // SeÃ§ili gruplarÄ± gÃ¶ster
                renderSelectedGroups();
            } catch (error) {
                showToast('âŒ Ayarlar yÃ¼klenirken hata oluÅŸtu: ' + error.message, 'error');
            }
        }

        // Kelimeleri virgÃ¼lle ayrÄ±lmÄ±ÅŸ string'den parse et
        function parseKeywords() {
            const input = document.getElementById('keywords-input');
            if (input) {
                const inputValue = input.value;
                keywords = inputValue.split(',')
                    .map(k => k.trim())
                    .filter(k => k.length > 0);
            }
        }

        function renderLinks() {
            const container = document.getElementById('links-list');
            container.innerHTML = '';
            links.forEach((link, index) => {
                const div = document.createElement('div');
                div.className = 'list-input';
                div.innerHTML = `
                    <input type="text" value="${link}" onchange="updateLink(${index}, this.value)">
                    <button type="button" class="btn btn-danger btn-small" onclick="removeLink(${index})">Sil</button>
                `;
                container.appendChild(div);
            });
        }


        // Toast Bildirimleri
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-content">${escapeHtml(message)}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
            `;
            
            container.appendChild(toast);
            
            // Otomatik kaldÄ±r
            setTimeout(() => {
                toast.classList.add('toast-exit');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 300);
            }, duration);
        }

        // Telegram API Test Fonksiyonu
        async function testTelegramAPI() {
            const apiId = document.getElementById('api_id').value.trim();
            const apiHash = document.getElementById('api_hash').value.trim();
            const phoneNumber = document.getElementById('phone_number').value.trim();
            const testBtn = document.getElementById('test-api-btn');
            
            if (!apiId || !apiHash) {
                showToast('LÃ¼tfen API ID ve API Hash bilgilerini girin!', 'error');
                return;
            }
            
            // Butonu devre dÄ±ÅŸÄ± bÄ±rak
            testBtn.disabled = true;
            testBtn.innerHTML = '<span class="loading-spinner"></span> Test ediliyor...';
            
            try {
                showToast('Telegram API baÄŸlantÄ±sÄ± test ediliyor...', 'info', 3000);
                
                const response = await fetch('/api/test-telegram', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        API_ID: apiId,
                        API_HASH: apiHash,
                        PHONE_NUMBER: phoneNumber
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('âœ… Telegram API baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±! API bilgileri doÄŸru.', 'success');
                } else {
                    showToast(`âŒ API Test HatasÄ±: ${data.message}`, 'error');
                }
            } catch (error) {
                showToast(`âŒ BaÄŸlantÄ± hatasÄ±: ${error.message}`, 'error');
            } finally {
                // Butonu tekrar aktif et
                testBtn.disabled = false;
                testBtn.innerHTML = 'ğŸ§ª Test Et';
            }
        }

        document.getElementById('configForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Kelimeleri parse et
            parseKeywords();
            
            // API_HASH'i localStorage'a kaydet (kalÄ±cÄ±lÄ±k iÃ§in)
            const apiHash = document.getElementById('api_hash').value;
            if (apiHash && apiHash !== '***') {
                localStorage.setItem('api_hash', apiHash);
            }
            
            // Grup bilgilerini tam olarak kaydet (id, name, startDate, endDate)
            const groupIdsToSave = selectedGroups.map(g => {
                if (typeof g === 'object') {
                    return {
                        id: g.id,
                        name: g.name || allGroupsCache[g.id]?.name || `Grup ${g.id}`, // Ä°smi de kaydet
                        startDate: g.startDate || null,
                        endDate: g.endDate || null
                    };
                }
                return {
                    id: g,
                    name: allGroupsCache[g]?.name || `Grup ${g}`,
                    startDate: null,
                    endDate: null
                };
            });
            
            const config = {
                API_ID: document.getElementById('api_id').value,
                API_HASH: apiHash,
                PHONE_NUMBER: document.getElementById('phone_number').value,
                SEARCH_KEYWORDS: keywords.filter(k => k.trim()),
                SEARCH_LINKS: links.filter(l => l.trim()),
                GROUP_IDS: groupIdsToSave, // Tam grup bilgilerini gÃ¶nder
                SCAN_TIME_RANGE: document.getElementById('scan_time_range').value
            };

            try {
                showToast('Ayarlar kaydediliyor...', 'info', 2000);
                
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const data = await response.json();
                if (data.success) {
                    showToast('âœ… Ayarlar baÅŸarÄ±yla kaydedildi!', 'success');
                } else {
                    showToast(`âŒ ${data.message || 'Kaydetme hatasÄ±!'}`, 'error');
                }
            } catch (error) {
                showToast(`âŒ Hata: ${error.message}`, 'error');
            }
        });

        // Grup Arama
        async function searchGroups() {
            const searchTerm = document.getElementById('search-group-name').value.trim();
            const searchBtn = document.getElementById('search-group-btn');
            const resultsDiv = document.getElementById('search-results');
            const resultsList = document.getElementById('search-results-list');
            
            if (!searchTerm) {
                showToast('âŒ LÃ¼tfen grup adÄ± girin!', 'error');
                return;
            }
            
            // Butonu devre dÄ±ÅŸÄ± bÄ±rak
            if (searchBtn) {
                searchBtn.disabled = true;
                searchBtn.innerHTML = '<span class="loading-spinner"></span> AranÄ±yor...';
            }
            
            if (resultsList) {
                resultsList.innerHTML = '<div class="loading">Gruplar yÃ¼kleniyor...</div>';
            }
            
            if (resultsDiv) {
                resultsDiv.style.display = 'block';
            }
            
            try {
                // Telegram'da gerÃ§ek arama yap
                showToast('Telegram\'da aranÄ±yor...', 'info', 2000);
                
                if (resultsList) {
                    resultsList.innerHTML = '<div class="loading">Telegram\'da aranÄ±yor...</div>';
                }
                
                const response = await fetch('/api/groups/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({search_term: searchTerm})
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    if (resultsList) {
                        resultsList.innerHTML = `<div class="alert alert-error">${data.message || 'Arama hatasÄ±'}</div>`;
                    }
                    showToast(`âŒ ${data.message || 'Arama hatasÄ±'}`, 'error');
                    return;
                }
                
                if (!data.groups || data.groups.length === 0) {
                    if (resultsList) {
                        resultsList.innerHTML = `<div class="alert">"${escapeHtml(searchTerm)}" iÃ§in grup bulunamadÄ±. Ãœye olduÄŸunuz gruplar iÃ§inde arama yapÄ±ldÄ±.</div>`;
                    }
                    showToast(`âš ï¸ "${searchTerm}" iÃ§in grup bulunamadÄ±.`, 'warning');
                    return;
                }
                
                // SonuÃ§larÄ± gÃ¶ster
                let html = '';
                data.groups.forEach(group => {
                    if (!group || !group.id) return;
                    
                    // Grup bilgisini cache'e ekle
                    allGroupsCache[group.id] = group;
                    
                    const isSelected = selectedGroups.some(g => (typeof g === 'object' ? g.id : g) === group.id);
                    const safeName = (group.name || 'Ä°simsiz Grup').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');
                    const groupType = group.is_channel ? 'ğŸ“¢ Kanal' : 'ğŸ‘¥ Grup';
                    html += `
                        <div class="group-item" style="margin-bottom: 10px; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div class="group-info" style="flex: 1;">
                                <div class="group-name" style="font-weight: 600; color: #333; margin-bottom: 4px;">${escapeHtml(group.name || 'Ä°simsiz Grup')}</div>
                                <div style="font-size: 12px; color: #666;">
                                    <span>${groupType}</span> | <span>ID: ${group.id}</span>
                                </div>
                            </div>
                            ${isSelected ? 
                                '<span style="color: #28a745; font-weight: 600; padding: 5px 10px;">âœ“ Ekli</span>' :
                                `<button type="button" class="btn btn-primary btn-small" onclick="addGroupFromSearch(${group.id}, '${safeName}')" style="padding: 6px 12px; font-size: 12px;">â• Ekle</button>`
                            }
                        </div>
                    `;
                });
                
                if (resultsList) {
                    resultsList.innerHTML = html || '<div class="alert">SonuÃ§ bulunamadÄ±.</div>';
                }
                showToast(`âœ… ${data.groups.length} grup bulundu!`, 'success');
                
            } catch (error) {
                console.error('Grup arama hatasÄ±:', error);
                if (resultsList) {
                    resultsList.innerHTML = `<div class="alert alert-error">Hata: ${error.message}</div>`;
                }
                showToast(`âŒ Arama hatasÄ±: ${error.message}`, 'error');
            } finally {
                if (searchBtn) {
                    searchBtn.disabled = false;
                    searchBtn.innerHTML = 'ğŸ” Ara';
                }
            }
        }

        // Arama sonuÃ§larÄ±ndan grup ekle
        function addGroupFromSearch(groupId, groupName) {
            // Grup zaten ekli mi kontrol et
            if (selectedGroups.some(g => (typeof g === 'object' ? g.id : g) === groupId)) {
                showToast('âš ï¸ Bu grup zaten ekli!', 'warning');
                return;
            }
            
            // Grup bilgisini cache'e ekle
            allGroupsCache[groupId] = { id: groupId, name: groupName };
            
            // Grup bilgisini ekle (tarih aralÄ±ÄŸÄ± ile)
            selectedGroups.push({ 
                id: groupId, 
                name: groupName,
                startDate: '',
                endDate: ''
            });
            showToast(`âœ… Grup eklendi: ${groupName}`, 'success');
            renderSelectedGroups();
            
            // Arama sonuÃ§larÄ±nÄ± gÃ¼ncelle
            setTimeout(() => {
                searchGroups();
            }, 500);
        }

        // Input'tan grup/kanal ekle (link veya isim)
        async function addGroupsFromInput() {
            const input = document.getElementById('search-group-name');
            const inputValue = input.value.trim();
            
            if (!inputValue) {
                showToast('âŒ LÃ¼tfen grup adÄ± veya Telegram linki girin!', 'error');
                return;
            }
            
            // Input'u satÄ±rlara bÃ¶l veya virgÃ¼lle ayÄ±r
            const lines = inputValue.split('\n').map(l => l.trim()).filter(l => l);
            const items = [];
            
            lines.forEach(line => {
                // VirgÃ¼lle ayrÄ±lmÄ±ÅŸ Ã¶ÄŸeleri de kontrol et
                const commaSeparated = line.split(',').map(i => i.trim()).filter(i => i);
                items.push(...commaSeparated);
            });
            
            if (items.length === 0) {
                showToast('âŒ GeÃ§erli bir grup adÄ± veya link girin!', 'error');
                return;
            }
            
            const btn = document.getElementById('search-group-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Ekleniyor...';
            
            let addedCount = 0;
            let errorCount = 0;
            
            for (const item of items) {
                try {
                    // Link mi kontrol et
                    let username = null;
                    if (item.includes('t.me/') || item.includes('telegram.me/')) {
                        // Link'ten username Ã§Ä±kar
                        const match = item.match(/(?:t\.me|telegram\.me)\/([a-zA-Z0-9_]+)/);
                        if (match && match[1]) {
                            username = match[1];
                        }
                    } else if (item.startsWith('@')) {
                        // @ ile baÅŸlÄ±yorsa
                        username = item.substring(1);
                    } else {
                        // Sadece isim ise arama yap
                        username = null;
                    }
                    
                    if (username) {
                        // Link'ten grup bilgilerini Ã§ek
                        const response = await fetch('/api/groups/add-by-username', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({username: username})
                        });
                        
                        const data = await response.json();
                        if (data.success && data.group) {
                            const group = data.group;
                            // Grup zaten ekli mi kontrol et
                            if (!selectedGroups.some(g => (typeof g === 'object' ? g.id : g) === group.id)) {
                                allGroupsCache[group.id] = group;
                                selectedGroups.push({
                                    id: group.id,
                                    name: group.name || username,
                                    startDate: '',
                                    endDate: ''
                                });
                                addedCount++;
                            }
                        } else {
                            const errorMsg = data.message || 'Bilinmeyen hata';
                            console.error(`Grup ekleme hatasÄ± (${username}):`, errorMsg);
                            console.error('Backend response:', data);
                            errorCount++;
                        }
                    } else {
                        // Ä°sim ile arama yap
                        const response = await fetch('/api/groups/search', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({search_term: item})
                        });
                        
                        const data = await response.json();
                        if (data.success && data.groups && data.groups.length > 0) {
                            const group = data.groups[0]; // Ä°lk sonucu al
                            if (!selectedGroups.some(g => (typeof g === 'object' ? g.id : g) === group.id)) {
                                allGroupsCache[group.id] = group;
                                selectedGroups.push({
                                    id: group.id,
                                    name: group.name || item,
                                    startDate: '',
                                    endDate: ''
                                });
                                addedCount++;
                            }
                        } else {
                            const errorMsg = data.message || 'Grup bulunamadÄ±';
                            console.error(`Grup arama hatasÄ± (${item}):`, errorMsg);
                            console.error('Backend response:', data);
                            errorCount++;
                        }
                    }
                } catch (error) {
                    console.error('Grup ekleme hatasÄ± (network/exception):', error);
                    console.error('Hata detaylarÄ±:', {
                        message: error.message,
                        stack: error.stack,
                        item: item
                    });
                    errorCount++;
                }
            }
            
            btn.disabled = false;
            btn.innerHTML = 'â• Ekle';
            input.value = ''; // Input'u temizle
            
            if (addedCount > 0) {
                showToast(`âœ… ${addedCount} grup eklendi!${errorCount > 0 ? ` (${errorCount} hata)` : ''}`, 'success');
                renderSelectedGroups();
            } else {
                // Hata mesajlarÄ±nÄ± kontrol et - eÄŸer giriÅŸ yapÄ±lmamÄ±ÅŸsa Ã¶zel mesaj gÃ¶ster
                const hasLoginError = errorCount > 0;
                let errorMsg = '';
                if (hasLoginError) {
                    errorMsg = `âŒ HiÃ§bir grup eklenemedi. (${errorCount} hata)\n\n`;
                    errorMsg += 'ğŸ” Telegram\'a giriÅŸ yapmanÄ±z gerekiyor!\n';
                    errorMsg += 'LÃ¼tfen "Gruplar" sekmesinden "Telegram\'a GiriÅŸ Yap" butonuna tÄ±klayÄ±n.';
                    // GiriÅŸ modalÄ±nÄ± otomatik aÃ§
                    setTimeout(() => {
                        if (typeof showLoginModal === 'function') {
                            showLoginModal();
                        }
                    }, 1000);
                } else {
                    errorMsg = 'âŒ HiÃ§bir grup eklenemedi. LÃ¼tfen konsolu (F12) kontrol edin.';
                }
                showToast(errorMsg, 'error', 15000);
                console.error('Grup ekleme baÅŸarÄ±sÄ±z. TÃ¼m hatalar yukarÄ±da listelenmiÅŸtir.');
            }
        }

        // SeÃ§ili GruplarÄ± HTML Olarak DÃ¶ndÃ¼r
        function renderSelectedGroupsHTML() {
            if (selectedGroups.length === 0) {
                return '';
            }
            
            let html = '<div class="groups-list"><h3 style="margin-bottom: 15px;">SeÃ§ili Gruplar:</h3>';
            selectedGroups.forEach((group, index) => {
                // EÄŸer group bir obje deÄŸilse (eski format), dÃ¶nÃ¼ÅŸtÃ¼r
                const groupId = typeof group === 'object' ? group.id : group;
                const groupName = typeof group === 'object' ? group.name : (allGroupsCache[groupId]?.name || `Grup ${groupId}`);
                
                const startDate = typeof group === 'object' && group.startDate ? group.startDate : '';
                const endDate = typeof group === 'object' && group.endDate ? group.endDate : '';
                
                html += `
                    <div class="group-item" style="margin-bottom: 15px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background: #f8f9fa;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div class="group-info" style="flex: 1;">
                                <div class="group-name" style="font-weight: 600; color: #333; font-size: 18px;">${escapeHtml(groupName)}</div>
                            </div>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeGroup(${index})" style="padding: 6px 12px; font-size: 12px;">Sil</button>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #dee2e6;">
                            <label style="font-size: 12px; font-weight: 600; color: #495057; display: block; margin-bottom: 5px;">ğŸ“… Tarih AralÄ±ÄŸÄ± (Bu grup iÃ§in):</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <div>
                                    <label style="font-size: 11px; color: #666; display: block; margin-bottom: 3px;">BaÅŸlangÄ±Ã§:</label>
                                    <input type="date" id="group-${index}-start" value="${startDate}" onchange="updateGroupDateRange(${index}, 'start', this.value)" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;">
                                </div>
                                <div>
                                    <label style="font-size: 11px; color: #666; display: block; margin-bottom: 3px;">BitiÅŸ:</label>
                                    <input type="date" id="group-${index}-end" value="${endDate}" onchange="updateGroupDateRange(${index}, 'end', this.value)" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        // Grup tarih aralÄ±ÄŸÄ±nÄ± gÃ¼ncelle
        function updateGroupDateRange(index, type, value) {
            if (selectedGroups[index] && typeof selectedGroups[index] === 'object') {
                if (type === 'start') {
                    selectedGroups[index].startDate = value;
                } else {
                    selectedGroups[index].endDate = value;
                }
            }
        }

        // SeÃ§ili GruplarÄ± GÃ¶ster
        function renderSelectedGroups() {
            const container = document.getElementById('groups-container');
            
            if (selectedGroups.length === 0) {
                container.innerHTML = '<div class="alert">HenÃ¼z grup seÃ§ilmedi.</div>';
                return;
            }
            
            container.innerHTML = renderSelectedGroupsHTML();
        }

        // Grup KaldÄ±r
        function removeGroup(index) {
            const removedId = selectedGroups[index];
            selectedGroups.splice(index, 1);
            showToast(`âœ… Grup kaldÄ±rÄ±ldÄ±: ${removedId}`, 'success');
            renderSelectedGroups();
        }

        // Grup SeÃ§imlerini Kaydet
        async function saveGroupSelection() {
            try {
                showToast('Grup seÃ§imleri kaydediliyor...', 'info', 2000);
                
                // Grup bilgilerini tam olarak hazÄ±rla (id, name, startDate, endDate)
                const groupsToSave = selectedGroups.map(g => {
                    if (typeof g === 'object') {
                        return {
                            id: g.id,
                            name: g.name || allGroupsCache[g.id]?.name || `Grup ${g.id}`,
                            startDate: g.startDate || null,
                            endDate: g.endDate || null
                        };
                    }
                    return {
                        id: g,
                        name: allGroupsCache[g]?.name || `Grup ${g}`,
                        startDate: null,
                        endDate: null
                    };
                });
                
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        GROUP_IDS: groupsToSave
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showToast(`âœ… ${selectedGroups.length} grup seÃ§imi kaydedildi!`, 'success');
                } else {
                    showToast(`âŒ ${data.message || 'Kaydetme hatasÄ±!'}`, 'error');
                }
            } catch (error) {
                showToast(`âŒ Hata: ${error.message}`, 'error');
            }
        }

        async function loadGroups() {
            const container = document.getElementById('groups-container');
            container.innerHTML = '<div class="loading">Gruplar yÃ¼kleniyor...<br><small>Bu iÅŸlem birkaÃ§ saniye sÃ¼rebilir.</small></div>';
            showToast('Gruplar yÃ¼kleniyor...', 'info', 5000);

            try {
                const response = await fetch('/api/groups');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();

                if (!data.success) {
                    const errorMsg = data.message || 'Grup yÃ¼kleme hatasÄ±';
                    let solutionHTML = '';
                    
                    if (errorMsg.includes('giriÅŸ yapÄ±lmamÄ±ÅŸ') || errorMsg.includes('not authorized') || errorMsg.includes('unauthorized')) {
                        solutionHTML = `
                            <div class="alert alert-error">
                                <strong>âŒ Telegram GiriÅŸi Gerekli</strong><br><br>
                                Telegram hesabÄ±nÄ±za giriÅŸ yapmanÄ±z gerekiyor.<br><br>
                                <strong>HÄ±zlÄ± Ã‡Ã¶zÃ¼m:</strong><br>
                                <button class="btn btn-primary" onclick="showLoginModal()" style="margin-top: 10px;">ğŸ” Telegram'a GiriÅŸ Yap</button><br><br>
                                <strong>Alternatif (Terminal):</strong><br>
                                Terminal'de ÅŸu komutu Ã§alÄ±ÅŸtÄ±rÄ±n:<br>
                                <code style="background: #f0f0f0; padding: 5px; border-radius: 3px; display: block; margin: 5px 0;">python tg_monitor.py</code><br>
                                <small style="color: #666;">Not: Dosya adÄ± <strong>tg_monitor.py</strong> (alt Ã§izgi ile, nokta ile deÄŸil!)</small><br>
                                Ä°lk Ã§alÄ±ÅŸtÄ±rmada telefon numaranÄ±za kod gÃ¶nderilecek, kodu girin.
                            </div>
                        `;
                    } else {
                        solutionHTML = `
                            <div class="alert alert-error">
                                <strong>âŒ Hata:</strong> ${escapeHtml(errorMsg)}<br><br>
                                <strong>Ã‡Ã¶zÃ¼m:</strong><br>
                                1. Ayarlar sekmesinden API ID ve API Hash bilgilerinizi kontrol edin<br>
                                2. "Test Et" butonuna tÄ±klayarak API bilgilerinizi test edin<br>
                                3. EÄŸer ilk kez kullanÄ±yorsanÄ±z, Ã¶nce Telegram'a giriÅŸ yapÄ±n
                            </div>
                        `;
                    }
                    
                    container.innerHTML = solutionHTML;
                    showToast(`âŒ ${errorMsg}`, 'error', 8000);
                    return;
                }

                if (!data.groups || data.groups.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-error">
                            <strong>âš ï¸ Grup bulunamadÄ±</strong><br><br>
                            OlasÄ± nedenler:<br>
                            1. Telegram hesabÄ±nÄ±za giriÅŸ yapÄ±lmamÄ±ÅŸ (Ã¶nce tg_monitor.py Ã§alÄ±ÅŸtÄ±rÄ±n)<br>
                            2. HiÃ§ gruba Ã¼ye deÄŸilsiniz<br>
                            3. API bilgileri yanlÄ±ÅŸ
                        </div>
                    `;
                    showToast('âš ï¸ Grup bulunamadÄ±. LÃ¼tfen yukarÄ±daki bilgileri kontrol edin.', 'warning', 8000);
                    return;
                }
                
                showToast(`âœ… ${data.groups.length} grup bulundu!`, 'success');
                
                // GruplarÄ± listele
                let html = '<div class="groups-list"><h3 style="margin-bottom: 15px;">Telegram GruplarÄ± (' + data.groups.length + '):</h3>';
                data.groups.forEach(group => {
                    // Grup bilgisini cache'e ekle
                    allGroupsCache[group.id] = group;
                    
                    const isSelected = selectedGroups.some(g => (typeof g === 'object' ? g.id : g) === group.id);
                    html += `
                        <div class="group-item">
                            <div class="group-info">
                                <div class="group-name">${escapeHtml(group.name || 'Ä°simsiz Grup')}</div>
                                <div class="group-id">ID: ${group.id}</div>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" ${isSelected ? 'checked' : ''} 
                                       onchange="toggleGroup(${group.id}, this.checked)">
                                <label>Ä°zle</label>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                // SeÃ§ili gruplarÄ± da ekle
                if (selectedGroups.length > 0) {
                    html += '<div style="margin-top: 30px;">';
                    html += renderSelectedGroupsHTML();
                    html += '</div>';
                }
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Grup yÃ¼kleme hatasÄ±:', error);
                container.innerHTML = `
                    <div class="alert alert-error">
                        <strong>âŒ Hata:</strong> ${escapeHtml(error.message)}<br><br>
                        LÃ¼tfen konsolu (F12) kontrol edin ve hata detaylarÄ±nÄ± inceleyin.
                    </div>
                `;
                showToast(`âŒ Hata: ${error.message}`, 'error', 8000);
            }
        }

        function toggleGroup(groupId, checked) {
            const group = allGroupsCache[groupId] || { id: groupId, name: `Grup ${groupId}` };
            
            if (checked) {
                if (!selectedGroups.some(g => (typeof g === 'object' ? g.id : g) === groupId)) {
                    selectedGroups.push(group);
                    showToast(`âœ… Grup eklendi: ${group.name}`, 'success');
                }
            } else {
                selectedGroups = selectedGroups.filter(g => (typeof g === 'object' ? g.id : g) !== groupId);
                showToast(`âœ… Grup kaldÄ±rÄ±ldÄ±: ${group.name}`, 'success');
            }
            // SeÃ§ili gruplarÄ± gÃ¼ncelle
            setTimeout(() => {
                renderSelectedGroups();
            }, 100);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        let allResults = []; // TÃ¼m sonuÃ§lar
        let filteredGroupNames = new Set(); // Filtrelenecek grup adlarÄ±
        let availableGroups = new Set(); // Mevcut tÃ¼m grup adlarÄ±

        async function loadResults() {
            const container = document.getElementById('results-container');
            
            container.innerHTML = '<div class="loading">SonuÃ§lar yÃ¼kleniyor...</div>';

            try {
                // TÃ¼m sonuÃ§larÄ± getir (tarih filtresi yok)
                const url = '/api/results';
                
                const response = await fetch(url);
                const data = await response.json();

                if (!data.success) {
                    container.innerHTML = `<div class="alert alert-error">${data.message}</div>`;
                    showToast(`âŒ ${data.message}`, 'error');
                    return;
                }

                // TÃ¼m sonuÃ§larÄ± sakla
                allResults = data.results || [];

                if (allResults.length === 0) {
                    container.innerHTML = '<div class="alert">HenÃ¼z sonuÃ§ bulunamadÄ±.</div>';
                    document.getElementById('results-count').textContent = '';
                    showToast('â„¹ï¸ HenÃ¼z sonuÃ§ bulunamadÄ±.', 'info');
                    return;
                }
                
                // TÃ¼m grup adlarÄ±nÄ± Ã§Ä±kar
                availableGroups.clear();
                allResults.forEach(result => {
                    const groupName = result['Grup'] || result['group_name'] || 'Bilinmeyen Grup';
                    availableGroups.add(groupName);
                });
                
                // Filtre listesini gÃ¼ncelle
                updateGroupFilterList();
                
                // SonuÃ§larÄ± gÃ¶ster (filtre uygulanmÄ±ÅŸ)
                applyGroupFilter();
            } catch (error) {
                container.innerHTML = `<div class="alert alert-error">Hata: ${error.message}</div>`;
            }
        }

        // Grup filtresini uygula
        function applyGroupFilter() {
            let filteredResults = allResults;
            
            // EÄŸer filtre seÃ§iliyse, sadece seÃ§ili gruplarÄ± gÃ¶ster
            if (filteredGroupNames.size > 0) {
                filteredResults = allResults.filter(result => {
                    const groupName = result['Grup'] || result['group_name'] || 'Bilinmeyen Grup';
                    return filteredGroupNames.has(groupName);
                });
            }
            
            // SonuÃ§ sayÄ±sÄ±nÄ± gÃ¼ncelle
            const totalCount = allResults.length;
            const filteredCount = filteredResults.length;
            if (filteredGroupNames.size > 0) {
                document.getElementById('results-count').textContent = `${filteredCount} / ${totalCount} sonuÃ§ bulundu`;
            } else {
                document.getElementById('results-count').textContent = `${totalCount} sonuÃ§ bulundu`;
            }
            
            // FiltrelenmiÅŸ sonuÃ§larÄ± gÃ¶ster
            renderResults(filteredResults);
        }
        
        // Grup filtre listesini gÃ¼ncelle
        function updateGroupFilterList() {
            const filterList = document.getElementById('group-filter-list');
            if (!filterList) return;
            
            if (availableGroups.size === 0) {
                filterList.innerHTML = '<div style="color: #999; font-size: 12px; text-align: center; padding: 20px;">HenÃ¼z grup bulunamadÄ±...</div>';
                return;
            }
            
            let html = '';
            const sortedGroups = Array.from(availableGroups).sort();
            
            sortedGroups.forEach(groupName => {
                const isChecked = filteredGroupNames.has(groupName);
                html += `
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background 0.2s; ${isChecked ? 'background: #e3f2fd;' : ''}" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='${isChecked ? '#e3f2fd' : 'transparent'}'">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleGroupFilterItem('${escapeHtml(groupName)}', this.checked)" style="cursor: pointer; width: 18px; height: 18px;">
                        <span style="flex: 1; font-size: 13px; color: #333;">${escapeHtml(groupName)}</span>
                        <span style="font-size: 11px; color: #999; background: #f0f0f0; padding: 2px 8px; border-radius: 10px;">
                            ${allResults.filter(r => (r['Grup'] || r['group_name'] || 'Bilinmeyen Grup') === groupName).length}
                        </span>
                    </label>
                `;
            });
            
            filterList.innerHTML = html;
            updateFilteredCount();
        }
        
        // Grup filtre Ã¶ÄŸesini aÃ§/kapa
        function toggleGroupFilterItem(groupName, checked) {
            if (checked) {
                filteredGroupNames.add(groupName);
            } else {
                filteredGroupNames.delete(groupName);
            }
            updateFilteredCount();
            applyGroupFilter();
        }
        
        // TÃ¼m gruplarÄ± seÃ§
        function selectAllGroups() {
            availableGroups.forEach(groupName => {
                filteredGroupNames.add(groupName);
            });
            updateGroupFilterList();
            applyGroupFilter();
        }
        
        // TÃ¼m gruplarÄ± temizle
        function deselectAllGroups() {
            filteredGroupNames.clear();
            updateGroupFilterList();
            applyGroupFilter();
        }
        
        // Filtre panelini gÃ¶ster/gizle
        function toggleGroupFilter() {
            const panel = document.getElementById('group-filter-panel');
            if (panel) {
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // FiltrelenmiÅŸ sayÄ±yÄ± gÃ¼ncelle
        function updateFilteredCount() {
            const countElement = document.getElementById('filtered-count');
            if (countElement) {
                countElement.textContent = filteredGroupNames.size;
            }
        }
        
        function renderResults(results) {
            const container = document.getElementById('results-container');
            
            // SonuÃ§ sayÄ±sÄ± zaten applyGroupFilter'da gÃ¼ncelleniyor

            if (results.length === 0) {
                container.innerHTML = '<div class="alert">SonuÃ§ bulunamadÄ±.</div>';
                return;
            }

            // SonuÃ§larÄ± gÃ¶ster (daha gÃ¼zel gÃ¶rÃ¼nÃ¼m)
            let html = '<div class="results-list" style="display: grid; gap: 20px;">';
            results.forEach((result, index) => {
                // Mesaj metnini al - farklÄ± formatlarÄ± dene
                let messageText = result['Mesaj'] || result['message_text'] || result['message'] || '';
                // EÄŸer mesaj boÅŸsa veya sadece boÅŸluk varsa
                if (!messageText || messageText.trim() === '' || messageText === 'N/A') {
                    messageText = 'Mesaj iÃ§eriÄŸi bulunamadÄ±.';
                }
                
                const groupName = result['Grup'] || result['group_name'] || 'Bilinmeyen Grup';
                const timestamp = result['Tarih'] || result['timestamp'] || 'N/A';
                
                // Bulunan kelimeleri dÃ¼zgÃ¼n parse et
                let foundKeywords = '';
                if (result['Bulunan Kelimeler']) {
                    foundKeywords = result['Bulunan Kelimeler'];
                } else if (result['found_keywords']) {
                    foundKeywords = Array.isArray(result['found_keywords']) 
                        ? result['found_keywords'].join(', ') 
                        : result['found_keywords'];
                }
                
                // Bulunan linkleri dÃ¼zgÃ¼n parse et
                let foundLinks = '';
                if (result['Bulunan Linkler']) {
                    foundLinks = result['Bulunan Linkler'];
                } else if (result['found_links']) {
                    foundLinks = Array.isArray(result['found_links']) 
                        ? result['found_links'].join(', ') 
                        : result['found_links'];
                }
                
                const messageLink = result['Link'] || result['message_link'] || '';
                
                // Tarihi formatla
                let formattedDate = timestamp;
                try {
                    const date = new Date(timestamp);
                    if (!isNaN(date.getTime())) {
                        formattedDate = date.toLocaleString('tr-TR', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                } catch (e) {}
                
                html += `
                    <div class="result-item" style="border-left: 5px solid #667eea; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; transition: transform 0.2s;">
                        <div class="group-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 18px 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0; font-size: 20px; font-weight: 700;">ğŸ“± ${escapeHtml(groupName)}</h4>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;">
                                    #${index + 1}
                                </div>
                            </div>
                        </div>
                        <div style="padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                                <span style="font-size: 24px;">ğŸ“…</span>
                                <div>
                                    <div style="font-weight: 600; color: #333; font-size: 15px;">${escapeHtml(formattedDate)}</div>
                                </div>
                            </div>
                            
                            ${foundKeywords ? `
                                <div style="margin-bottom: 15px;">
                                    <div style="font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px;">ğŸ”‘ Bulunan Kelimeler:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${foundKeywords.split(',').map(kw => kw.trim()).filter(kw => kw).map(kw => 
                                            `<span style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 13px; color: #856404; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${escapeHtml(kw)}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${foundLinks ? `
                                <div style="margin-bottom: 15px;">
                                    <div style="font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px;">ğŸ”— Bulunan Linkler:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${foundLinks.split(',').map(link => link.trim()).filter(link => link).map(link => 
                                            `<span style="background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 13px; color: #0c5460; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${escapeHtml(link)}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="message-box" style="margin-top: 20px; padding: 18px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border-left: 4px solid #667eea; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="font-weight: 700; color: #667eea; margin-bottom: 12px; font-size: 15px; display: flex; align-items: center; gap: 8px;">
                                    <span>ğŸ’¬</span>
                                    <span>Mesaj Ä°Ã§eriÄŸi</span>
                                </div>
                                <div style="color: #495057; white-space: pre-wrap; word-wrap: break-word; font-size: 14px; line-height: 1.7; background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                                    ${escapeHtml(messageText)}
                                </div>
                            </div>
                            
                            ${messageLink ? `
                                <div style="margin-top: 20px; text-align: center;">
                                    <a href="${messageLink}" target="_blank" style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 25px; font-weight: 600; font-size: 14px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)';">
                                        ğŸ”— Mesaja Git â†’
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }


        // Telegram GiriÅŸ Modal FonksiyonlarÄ±
        function showLoginModal() {
            document.getElementById('login-modal').style.display = 'flex';
            document.getElementById('login-step-1').style.display = 'block';
            document.getElementById('login-step-2').style.display = 'none';
            document.getElementById('login-step-password').style.display = 'none';
            document.getElementById('login-status').innerHTML = '';
        }

        function closeLoginModal() {
            document.getElementById('login-modal').style.display = 'none';
        }

        async function sendLoginCode() {
            const phone = document.getElementById('login-phone').value.trim();
            const statusDiv = document.getElementById('login-status');
            
            if (!phone) {
                statusDiv.innerHTML = '<div class="alert alert-error">LÃ¼tfen telefon numarasÄ± girin!</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="loading">Kod gÃ¶nderiliyor...</div>';
            
            try {
                const response = await fetch('/api/telegram-login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'send_code', phone: phone})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('login-step-1').style.display = 'none';
                    document.getElementById('login-step-2').style.display = 'block';
                    statusDiv.innerHTML = '<div class="alert alert-success">âœ… Kod gÃ¶nderildi! Telefon numaranÄ±za gelen kodu girin.</div>';
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-error">âŒ ${data.message}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-error">âŒ Hata: ${error.message}</div>`;
            }
        }

        async function verifyLoginCode() {
            const code = document.getElementById('login-code').value.trim();
            const phone = document.getElementById('login-phone').value.trim();
            const statusDiv = document.getElementById('login-status');
            
            if (!code) {
                statusDiv.innerHTML = '<div class="alert alert-error">LÃ¼tfen kodu girin!</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="loading">Kod doÄŸrulanÄ±yor...</div>';
            
            try {
                const response = await fetch('/api/telegram-login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'verify_code', phone: phone, code: code})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.requires_password) {
                        document.getElementById('login-step-2').style.display = 'none';
                        document.getElementById('login-step-password').style.display = 'block';
                        statusDiv.innerHTML = '<div class="alert alert-info">Ä°ki faktÃ¶rlÃ¼ doÄŸrulama ÅŸifresi gerekiyor.</div>';
                    } else {
                        statusDiv.innerHTML = '<div class="alert alert-success">âœ… GiriÅŸ baÅŸarÄ±lÄ±! ArtÄ±k gruplarÄ± yÃ¼kleyebilirsiniz.</div>';
                        setTimeout(() => {
                            closeLoginModal();
                            showToast('âœ… Telegram giriÅŸi baÅŸarÄ±lÄ±!', 'success');
                            loadGroups();
                        }, 2000);
                    }
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-error">âŒ ${data.message}</div>`;
                    console.error('GiriÅŸ hatasÄ±:', data);
                    showToast(`âŒ ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('GiriÅŸ exception hatasÄ±:', error);
                statusDiv.innerHTML = `<div class="alert alert-error">âŒ Hata: ${error.message}</div>`;
                showToast(`âŒ Hata: ${error.message}`, 'error');
            }
        }

        async function verifyLoginPassword() {
            const password = document.getElementById('login-password').value;
            const phone = document.getElementById('login-phone').value.trim();
            const statusDiv = document.getElementById('login-status');
            
            if (!password) {
                statusDiv.innerHTML = '<div class="alert alert-error">LÃ¼tfen ÅŸifreyi girin!</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="loading">Åifre doÄŸrulanÄ±yor...</div>';
            
            try {
                const response = await fetch('/api/telegram-login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'verify_password', phone: phone, password: password})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.innerHTML = '<div class="alert alert-success">âœ… GiriÅŸ baÅŸarÄ±lÄ±! ArtÄ±k gruplarÄ± yÃ¼kleyebilir ve botu baÅŸlatabilirsiniz.</div>';
                    showToast('âœ… Telegram giriÅŸi baÅŸarÄ±lÄ±!', 'success');
                    setTimeout(() => {
                        closeLoginModal();
                        loadGroups();
                    }, 2000);
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-error">âŒ ${data.message}</div>`;
                    showToast(`âŒ ${data.message}`, 'error');
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-error">âŒ Hata: ${error.message}</div>`;
            }
        }

        // Tarama fonksiyonu
        async function startScan() {
            const scanBtn = document.getElementById('scan-btn');
            const scanStatus = document.getElementById('scan-status');

            // SeÃ§ili grup kontrolÃ¼
            if (selectedGroups.length === 0) {
                showToast('âš ï¸ LÃ¼tfen Ã¶nce Ayarlar sekmesinden grup seÃ§in!', 'warning');
                return;
            }

            // Tarih kontrolÃ¼ - en az bir grubun tarihi olmalÄ± ve gelecekte olmamalÄ±
            let hasDateRange = false;
            let hasFutureDate = false;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let group of selectedGroups) {
                if (group.startDate || group.endDate) {
                    hasDateRange = true;
                    
                    // Gelecekteki tarih kontrolÃ¼
                    if (group.startDate) {
                        const startDate = new Date(group.startDate);
                        if (startDate > today) {
                            hasFutureDate = true;
                        }
                    }
                    if (group.endDate) {
                        const endDate = new Date(group.endDate);
                        if (endDate > today) {
                            hasFutureDate = true;
                        }
                    }
                }
            }

            if (!hasDateRange) {
                showToast('âš ï¸ LÃ¼tfen en az bir grup iÃ§in tarih aralÄ±ÄŸÄ± seÃ§in!', 'warning');
                return;
            }
            
            if (hasFutureDate) {
                const confirmed = confirm('âš ï¸ UYARI: BazÄ± gruplar iÃ§in gelecekteki tarihler seÃ§ilmiÅŸ!\n\nGelecekteki tarihlerde mesaj bulunamaz. Devam etmek istiyor musunuz?');
                if (!confirmed) {
                    scanBtn.disabled = false;
                    scanBtn.innerHTML = 'ğŸ” Tara';
                    return;
                }
            }

            scanBtn.disabled = true;
            scanBtn.innerHTML = '<span class="loading-spinner"></span> TaranÄ±yor...';
            scanStatus.style.display = 'block';
            const progressDiv = document.getElementById('scan-progress');
            progressDiv.style.display = 'block';
            
            // Progress bar'Ä± sÄ±fÄ±rla
            updateProgress(0, 'Tarama baÅŸlatÄ±lÄ±yor...');
            
            scanStatus.innerHTML = '<div class="alert" style="background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 15px; border-radius: 8px;"><strong>â³ Tarama baÅŸlatÄ±lÄ±yor...</strong><br>LÃ¼tfen bekleyin, bu iÅŸlem biraz zaman alabilir.</div>';

            try {
                // SeÃ§ili gruplarÄ±n tarih aralÄ±klarÄ±nÄ± gÃ¶nder
                const groupsToScan = selectedGroups.map(group => ({
                    id: typeof group === 'object' ? group.id : group,
                    startDate: group.startDate || null,
                    endDate: group.endDate || null
                }));

                updateProgress(10, 'Sunucuya istek gÃ¶nderiliyor...');

                const response = await fetch('/api/scan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        groups: groupsToScan
                    })
                });

                updateProgress(30, 'Sunucu yanÄ±tÄ± alÄ±nÄ±yor...');

                const data = await response.json();

                if (data.success) {
                    updateProgress(50, 'Tarama baÅŸlatÄ±ldÄ±, bot Ã§alÄ±ÅŸÄ±yor...');
                    scanStatus.innerHTML = '<div class="alert alert-success"><strong>âœ… Tarama baÅŸlatÄ±ldÄ±!</strong><br>Bot arka planda Ã§alÄ±ÅŸÄ±yor. Ä°lerleme durumu aÅŸaÄŸÄ±da gÃ¶steriliyor.</div>';
                    showToast('âœ… Tarama baÅŸlatÄ±ldÄ±!', 'success');
                    
                    // Debug panelini gÃ¶ster
                    const debugPanel = document.getElementById('debug-panel');
                    if (debugPanel) {
                        debugPanel.style.display = 'block';
                        updateDebugLogs(['[DEBUG] Tarama baÅŸlatÄ±ldÄ±, loglar bekleniyor...']);
                    }
                    
                    // Tarama durumunu periyodik olarak kontrol et
                    let checkCount = 0;
                    let lastResultCount = 0;
                    const checkInterval = setInterval(async () => {
                        checkCount++;
                        
                        try {
                            // Tarama durumunu kontrol et
                            const statusResponse = await fetch('/api/scan-status');
                            const statusData = await statusResponse.json();
                            
                            if (statusData.success) {
                                const isRunning = statusData.running;
                                const currentResultCount = statusData.result_count || 0;
                                
                                // Debug loglarÄ±nÄ± gÃ¶ster
                                if (statusData.logs && statusData.logs.length > 0) {
                                    updateDebugLogs(statusData.logs);
                                }
                                
                                // Progress hesapla
                                let progress = 50;
                                if (checkCount > 0) {
                                    progress = Math.min(50 + (checkCount * 3), 95);
                                }
                                
                                // EÄŸer yeni sonuÃ§ varsa progress artÄ±r
                                if (currentResultCount > lastResultCount) {
                                    progress = Math.min(progress + 5, 95);
                                    lastResultCount = currentResultCount;
                                }
                                
                                updateProgress(progress, `Tarama devam ediyor... (${currentResultCount} sonuÃ§ bulundu, ${statusData.log_count || 0} log)`);
                                
                                // SonuÃ§larÄ± gÃ¼ncelle
                                await loadResults();
                                
                                // EÄŸer tarama bitti ise
                                if (!isRunning) {
                                    clearInterval(checkInterval);
                                    updateProgress(100, 'Tarama tamamlandÄ±!');
                                    scanStatus.innerHTML = '<div class="alert alert-success"><strong>âœ… Tarama tamamlandÄ±!</strong><br>SonuÃ§lar yukarÄ±da gÃ¶steriliyor.</div>';
                                    scanBtn.disabled = false;
                                    scanBtn.innerHTML = 'ğŸ” Tara';
                                    progressDiv.style.display = 'none';
                                    await loadResults(); // Son kez sonuÃ§larÄ± yÃ¼kle
                                }
                            }
                        } catch (error) {
                            console.error('Durum kontrolÃ¼ hatasÄ±:', error);
                        }
                        
                        // 120 saniye sonra timeout
                        if (checkCount >= 24) {
                            clearInterval(checkInterval);
                            updateProgress(100, 'Tarama sÃ¼resi doldu');
                            scanStatus.innerHTML = '<div class="alert alert-warning"><strong>â±ï¸ Tarama sÃ¼resi doldu</strong><br>SonuÃ§larÄ± kontrol etmek iÃ§in "SonuÃ§larÄ± Yenile" butonuna tÄ±klayÄ±n.</div>';
                            scanBtn.disabled = false;
                            scanBtn.innerHTML = 'ğŸ” Tara';
                            progressDiv.style.display = 'none';
                        }
                    }, 5000);
                } else {
                    updateProgress(0, 'Hata oluÅŸtu!');
                    scanStatus.innerHTML = `<div class="alert alert-error"><strong>âŒ Hata:</strong> ${data.message}</div>`;
                    showToast(`âŒ ${data.message}`, 'error');
                    progressDiv.style.display = 'none';
                    scanBtn.disabled = false;
                    scanBtn.innerHTML = 'ğŸ” Tara';
                }
            } catch (error) {
                updateProgress(0, 'Hata oluÅŸtu!');
                scanStatus.innerHTML = `<div class="alert alert-error"><strong>âŒ Hata:</strong> ${error.message}</div>`;
                showToast(`âŒ Tarama hatasÄ±: ${error.message}`, 'error');
                progressDiv.style.display = 'none';
                scanBtn.disabled = false;
                scanBtn.innerHTML = 'ğŸ” Tara';
            }
        }
        
        // Progress bar gÃ¼ncelleme fonksiyonu
        function updateProgress(percent, text) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressDetails = document.getElementById('progress-details');
            
            if (progressBar && progressText && progressDetails) {
                progressBar.style.width = percent + '%';
                progressText.textContent = Math.round(percent) + '%';
                progressDetails.textContent = text;
            }
        }
        
        // Debug paneli gÃ¶ster/gizle
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            if (panel) {
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Debug loglarÄ±nÄ± gÃ¼ncelle
        function updateDebugLogs(logs) {
            const debugContent = document.getElementById('debug-content');
            if (!debugContent) return;
            
            // Son 30 log'u gÃ¶ster
            const recentLogs = logs.slice(-30);
            debugContent.innerHTML = recentLogs.map(log => {
                // Log tipine gÃ¶re renk
                let color = '#0f0'; // YeÅŸil (normal)
                if (log.includes('[HATA]') || log.includes('[ERROR]') || log.includes('âŒ')) {
                    color = '#f00'; // KÄ±rmÄ±zÄ± (hata)
                } else if (log.includes('[UYARI]') || log.includes('[WARNING]') || log.includes('âš ï¸')) {
                    color = '#ff0'; // SarÄ± (uyarÄ±)
                } else if (log.includes('[OK]') || log.includes('[TAMAMLANDI]') || log.includes('âœ…')) {
                    color = '#0ff'; // Cyan (baÅŸarÄ±)
                } else if (log.includes('[TARAMA]') || log.includes('[MESAJLAR]')) {
                    color = '#0ff'; // Cyan (bilgi)
                }
                
                return `<div style="color: ${color};">${escapeHtml(log)}</div>`;
            }).join('');
            
            // Scroll'u en alta kaydÄ±r
            debugContent.scrollTop = debugContent.scrollHeight;
        }
        
        // Debug loglarÄ±nÄ± yenile
        async function refreshDebugLogs() {
            try {
                const response = await fetch('/api/scan-status');
                const data = await response.json();
                if (data.success && data.logs) {
                    updateDebugLogs(data.logs);
                }
            } catch (error) {
                console.error('Debug log yenileme hatasÄ±:', error);
            }
        }
        
        // Debug loglarÄ±nÄ± temizle
        function clearDebugLogs() {
            const debugContent = document.getElementById('debug-content');
            if (debugContent) {
                debugContent.innerHTML = '<div style="color: #0f0;">[DEBUG] Loglar temizlendi...</div>';
            }
        }

        // Silme modalÄ±nÄ± gÃ¶ster
        function clearOldResults() {
            document.getElementById('delete-confirm-modal').style.display = 'flex';
        }

        // Silme modalÄ±nÄ± kapat
        function closeDeleteModal() {
            document.getElementById('delete-confirm-modal').style.display = 'none';
        }

        // Silme iÅŸlemini onayla ve gerÃ§ekleÅŸtir
        async function confirmDelete() {
            closeDeleteModal(); // ModalÄ± kapat
            
            try {
                showToast('ğŸ—‘ï¸ SonuÃ§lar temizleniyor...', 'info');
                
                const response = await fetch('/api/results/clear', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                const data = await response.json();

                if (data.success) {
                    showToast('âœ… TÃ¼m sonuÃ§lar baÅŸarÄ±yla temizlendi!', 'success', 3000);
                    // SonuÃ§larÄ± yeniden yÃ¼kle (boÅŸ olacak)
                    setTimeout(() => {
                        loadResults();
                    }, 500);
                } else {
                    showToast(`âŒ Hata: ${data.message}`, 'error', 5000);
                }
            } catch (error) {
                console.error('Temizleme hatasÄ±:', error);
                showToast(`âŒ Hata: ${error.message}`, 'error', 5000);
            }
        }

    </script>
</body>
</html>

